# Development Docker Compose - All services with hot reload
# Usage: docker-compose -f docker-compose.dev.yml up
#
# Uses node:lts base image and mounts source code for hot reload.
# No separate Dockerfile.dev needed - commands are specified inline.

services:
  # =============================================================================
  # INFRASTRUCTURE SERVICES
  # =============================================================================

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: loop
      POSTGRES_PASSWORD: loop
      POSTGRES_DB: loop
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U loop"]
      interval: 5s
      timeout: 5s
      retries: 5

  temporal:
    image: temporalio/auto-setup:1.24
    environment:
      - DB=postgres12
      - DB_PORT=5432
      - POSTGRES_USER=loop
      - POSTGRES_PWD=loop
      - POSTGRES_SEEDS=postgres
      - PROMETHEUS_ENDPOINT=0.0.0.0:8000
    ports:
      - "7233:7233"
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy

  temporal-ui:
    image: temporalio/ui:2.26.2
    environment:
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_CORS_ORIGINS=http://localhost:3000,http://localhost:5173
    ports:
      - "8080:8080"
    depends_on:
      - temporal

  openobserve:
    image: public.ecr.aws/zinclabs/openobserve:latest
    environment:
      - ZO_DATA_DIR=/data
      - ZO_ROOT_USER_EMAIL=admin@loop.dev
      - ZO_ROOT_USER_PASSWORD=admin123
    ports:
      - "5080:5080"
    volumes:
      - openobserve_data:/data

  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./infrastructure/otel-collector/otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    ports:
      - "4317:4317"
      - "4318:4318"
    depends_on:
      - openobserve
      - temporal

  # =============================================================================
  # APPLICATION SERVICES
  # =============================================================================

  backend:
    image: node:lts
    working_dir: /app
    command: sh -c "npm install && npm run dev"
    ports:
      - "3000:3000"
    volumes:
      - ./backend:/app
      - backend_node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
      - PORT=3000
      - DATABASE_URL=postgresql://loop:loop@postgres:5432/loop
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_NAMESPACE=default
      - JWT_SECRET=dev-jwt-secret-at-least-32-characters-long
      - ENCRYPTION_KEY=dev-encryption-key-at-least-32-chars
      - CORS_ORIGINS=http://localhost:5173
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
      - OTEL_SERVICE_NAME=loop-backend
    depends_on:
      postgres:
        condition: service_healthy
      temporal:
        condition: service_started
      otel-collector:
        condition: service_started

  backend-worker:
    image: node:lts
    working_dir: /app
    command: sh -c "npm install && npm run dev"
    volumes:
      - ./backend-worker:/app
      - backend_worker_node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
      - DATABASE_URL=postgresql://loop:loop@postgres:5432/loop
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_NAMESPACE=default
      - ENCRYPTION_KEY=dev-encryption-key-at-least-32-chars
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
      - OTEL_SERVICE_NAME=loop-backend-worker
    depends_on:
      postgres:
        condition: service_healthy
      temporal:
        condition: service_started
      otel-collector:
        condition: service_started

  processor-stripe:
    image: node:lts
    working_dir: /app
    command: sh -c "npm install && npm run dev"
    volumes:
      - ./processor-stripe:/app
      - processor_stripe_node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_NAMESPACE=default
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
      - OTEL_SERVICE_NAME=loop-processor-stripe
    depends_on:
      - temporal
      - otel-collector

  processor-razorpay:
    image: node:lts
    working_dir: /app
    command: sh -c "npm install && npm run dev"
    volumes:
      - ./processor-razorpay:/app
      - processor_razorpay_node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
      - TEMPORAL_ADDRESS=temporal:7233
      - TEMPORAL_NAMESPACE=default
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otel-collector:4318
      - OTEL_SERVICE_NAME=loop-processor-razorpay
    depends_on:
      - temporal
      - otel-collector

  dashboard:
    image: node:lts
    working_dir: /app
    command: sh -c "npm install --legacy-peer-deps && npm run dev -- --host 0.0.0.0"
    ports:
      - "5173:5173"
    volumes:
      - ./dashboard:/app
      - dashboard_node_modules:/app/node_modules
    environment:
      - NODE_ENV=development
      - PUBLIC_API_URL=http://localhost:3000
    depends_on:
      - backend

volumes:
  postgres_data:
  openobserve_data:
  backend_node_modules:
  backend_worker_node_modules:
  processor_stripe_node_modules:
  processor_razorpay_node_modules:
  dashboard_node_modules:
